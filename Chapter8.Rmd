---
title: "Chapter8"
author: "Julin N Maloof"
date: "7/30/2019"
output: 
  html_document: 
    keep_md: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rethinking)
library(tidyverse)
```

## 7E1
_For each of the causal relationships below, name a hypothetical third variable that would lead to an interaction effect._

_(1) Bread dough rises because of yeast_
Temperature

_(2) Education leads to higher income._
Job? Race? Gender?

_(3) Gasoline makes a car go._
Key? Spark?

## 7M1

## 7M2

_Recall the tulips example from the chapter. Suppose another set of treatments adjusted the temperature in the greenhouse over two levels: cold and hot. The data in the chapter were collected at the cold temperature. You find none of the plants grown under the hot temperature developed any blooms at all, regardless of the water and shade levels. Can you explain this result in terms of interactions between water, shade, and temperature?_

I am thinking that the way I would do this would be to remove the main effects of water and shade, and have W X temp, S X temp, and W X S X temp terms

## 7M2

_7M2. Can you invent a regression equation that would make the bloom size zero, whenever the temperature is hot?_

$$
bloom \sim \alpha_{[T]} + \beta_{WT} * W * T + \beta_{ST}*S*T + \beta_{WST}*W*S*T
$$
And code $T=1$ for cold and $T=0$ for hot

## 7M3

_In parts of North America, ravens depend upon wolves for their food. This is because ravens are carnivorous but cannot usually kill or open carcasses of prey. Wolves however can and do kill and tear open animals, and they tolerate ravens co-feeding at their kills. This species relationship is generally described as a “species interaction.” Can you invent a hypothetical set of data on raven population size in which this relationship would manifest as a statistical interaction? Do you think the biological interaction could be linear? Why or why not?_

Ravens ~ Wolves + Prey + Wolves:Prey

## 7H1
_Return to the data(tulips) example in the chapter. Now include the bed variable as a pre- dictor in the interaction model. Don’t interact bed with the other predictors; just include it as a main effect. Note that bed is categorical. So to use it properly, you will need to either construct dummy variables or rather an index variable, as explained in Chapter ??._

```{r}
library(tidyverse)
library(rethinking)
```

```{r}
data(tulips)
tulips
d <- tulips
```

Creat the index for bed
```{r}
d$bed_i <- as.numeric(d$bed)
d
```

normalize and center
```{r}
## R code 8.20
d$blooms_std <- d$blooms / max(d$blooms)
d$water_cent <- d$water - mean(d$water)
d$shade_cent <- d$shade - mean(d$shade)
```

run original model
```{r}
## R code 8.24
m8.7 <- quap(
    alist(
        blooms_std ~ dnorm( mu , sigma ) ,
        mu <- a + bw*water_cent + bs*shade_cent + bws*water_cent*shade_cent ,
        a ~ dnorm( 0.5 , 0.25 ) ,
        bw ~ dnorm( 0 , 0.25 ) ,
        bs ~ dnorm( 0 , 0.25 ) ,
        bws ~ dnorm( 0 , 0.25 ) ,
        sigma ~ dexp( 1 )
    ) ,
    data=d )
```

modified model with bed
```{r}
m8.7bed <- quap(
    alist(
        blooms_std ~ dnorm( mu , sigma ) ,
        mu <- a[bed_i] + bw*water_cent + bs*shade_cent + bws*water_cent*shade_cent ,
        a[bed_i] ~ dnorm( 0.5 , 0.25 ) ,
        bw ~ dnorm( 0 , 0.25 ) ,
        bs ~ dnorm( 0 , 0.25 ) ,
        bws ~ dnorm( 0 , 0.25 ) ,
        sigma ~ dexp( 1 )
    ) ,
    data=d )
```

take a look
```{r}
precis(m8.7)
```

```{r}
precis(m8.7bed, depth = 2)
```

```{r}
plot(coeftab(m8.7, m8.7bed))
```

we see that the confidence intervals on the beta coefficients have slightly shrunk, and that sigma is slightly smaller.

## 7H2
_Use WAIC to compare the model from 7H1 to a model that omits bed. What do you infer from this comparison? Can you reconcile the WAIC results with the posterior distribution of the bed coefficients?_

```{r}
compare(m8.7, m8.7bed)
```

The very small gains in parameter estimates are offset by the additional parameters. Similar models, no reason to prefer the one including bed.

## 7H3

_Use the tomato.csv (attached) data set and evaluate whether hypocotyl length ("hyp") is affected by shade ("trt"), species ("species") and their interaction._

```{r}
d <- read_csv("Tomato.csv") %>%
  select(hyp, trt, species) %>%
  na.omit()
d
```

Make a plot
```{r}
d %>%
  group_by(species,trt) %>%
  summarize(mean=mean(hyp), 
            sem=sd(hyp)/sqrt(n()), 
            ymax=mean+sem,
            ymin=mean-sem) %>%
  ggplot(aes(x=species, y=mean, ymax=ymax, ymin=ymin, fill=trt)) +
  geom_col(position = "dodge") +
  geom_errorbar(position = position_dodge(width=.9), width=.5)
```

make indices for the factors:
```{r}
d <- d %>%
  mutate(species_i = as.numeric(as.factor(species)),
         trt_i = as.numeric(as.factor(trt))-1)
```


fit non interaction model
```{r}
m1 <- quap(flist = alist(
  hyp ~ dnorm(mu, sigma),
  mu <- a[species_i] + b*trt_i, # one beta coefficient
  a[species_i] ~ dnorm(25, 5),
  b ~ dnorm(0, 5),
  sigma ~ dexp(1)),
  data=d, start=list(b=0, sigma=3))
```

check the priors
```{r}
prior <- extract.prior(m1)
str(prior)
d2 <- expand.grid(species_i=1:5, trt_i=0:1)
prior.pred <- link(m1, post=prior, data=d2)
colnames(prior.pred) <- str_c("species", d2$species_i, "_trt", d2$trt_i)
prior.pred %>% as_tibble() %>%
  gather() %>%
  ggplot(aes(x=key, y=value)) +
  geom_violin() +
  theme(axis.text.x = element_text(angle=90))
```


```{r}
precis(m1, depth=2)
```

now the interaction model:
```{r}
m2 <- quap(flist = alist(
  hyp ~ dnorm(mu, sigma),
  mu <- a[species_i] + b_int[species_i]*trt_i, # a beta coefficent for each species
  a[species_i] ~ dnorm(25, 5),
  b ~ dnorm(0, 5),
  b_int[species_i] ~ dnorm(0, 1),
  sigma ~ dexp(1)),
  data=d, start=list(b=0, sigma=3), control=list(maxit=500))
```

```{r}
precis(m2, depth=2)
```

```{r}
compare(m1,m2)
```

```{r}
m3 <- lm(hyp ~ species*trt, data=d)
summary(m3)
```


## quick dummy variable creation

```{r}
dummy <- tibble(ID=1:100, trt=sample(LETTERS[1:4], size = 100, replace=TRUE))
dummy %>% spread(key=trt,value=trt) %>%
  mutate_at(.vars=vars(-ID), ~ ifelse(is.na(.), 0, 1))
```

## 7H4

```{r}

```

